create sequence seq1;
create sequence seq2;
create table t1(ida int, age int);
select seq1.nextval, seq1.currval from dual;
nextval	currval
1	1
insert into t1 values(1, 2), (2, 3);
select seq1.nextval from t1;
nextval
2
3
select seq1.currval, t1.ida from t1 where t1.ida in (select age from t1);
currval	ida
3	2
select seq1.nextval+1 from t1;
seq1.nextval+1
5
6
select seq1.nextval+1, seq1.nextval "a", concat(seq1.nextval+age, 3), ida from t1;
seq1.nextval+1	a	concat(seq1.nextval+age, 3)	ida
7	6	83	1
8	7	103	2
select seq1.currval from t1;
currval
7
7
select seq1.currval, floor(seq1.nextval) from t1;
currval	floor(seq1.nextval)
8	8
9	9
insert into t1 select seq1.nextval, seq1.currval from t1;
select * from t1;
ida	age
1	2
2	3
10	10
11	11
insert into t1 values(seq1.nextval, 11);
insert into t1 values(seq1.nextval, seq1.currval);
insert into t1 values(seq1.currval,seq1.currval),(seq1.currval,seq1.currval);
ERROR HY000: wrong position for sequence: sequence appears more than one row!
insert into t1 values(seq1.currval, 110);
select * from t1;
ida	age
1	2
2	3
10	10
11	11
12	11
13	13
13	110
update t1 set ida = seq1.nextval, age = seq1.currval where ida = 1;
update t1 set ida = seq1.nextval, age = seq1.nextval+2 where ida is not null;
select * from t1;
ida	age
15	17
16	18
17	19
18	20
19	21
20	22
21	23
create table t2(ida int, age int);
insert into t2 values(1, 4), (2, 5);
insert into t2 select seq1.nextval, floor(seq2.nextval) from t1;
select * from t2;
ida	age
1	4
2	5
22	1
23	2
24	3
25	4
26	5
27	6
28	7
select seq1.currval, seq2.nextval, seq1.nextval from t1 where t1.ida in (select age from t1);
currval	nextval	nextval
29	8	29
30	9	30
31	10	31
32	11	32
33	12	33
select * from t1;
ida	age
15	17
16	18
17	19
18	20
19	21
20	22
21	23
select case when seq1.currval = 14 then 14 else seq1.nextval end from t1;
case when seq1.currval = 14 then 14 else seq1.nextval end
34
35
36
37
38
39
40
select case when seq1.nextval is null then true else false end from t1;
case when seq1.nextval is null then true else false end
0
0
0
0
0
0
0
select * from t1 where seq1.nextval > 5;
ERROR HY000: wrong position for sequence: 
select count(*) from t1 group by seq1.nextval, ida;
ERROR HY000: wrong position for sequence: 
select distinct ida, seq1.currval from t1;
ERROR HY000: wrong position for sequence: 
select * from t1 where t1.ida in (select seq1.nextval from t1);
ERROR HY000: wrong position for sequence: test.seq1
select * from t1 join t1 t2 on t1.ida = seq1.nextval;
ERROR HY000: wrong position for sequence: 
select seq1.nextval, ida from t1 union select ida, age from t1;
ERROR HY000: wrong position for sequence: 
select 1, ida from t1 union select ida, seq1.currval from t1;
ERROR HY000: wrong position for sequence: 
select seq1.currval from t1 order by ida;
ERROR HY000: wrong position for sequence: 
update t1 join t2 on t1.ida > t2.ida set t1.ida = seq1.nextval, t2.ida = seq2.nextval;
ERROR HY000: wrong position for sequence: 
update t1, t2 set t1.ida = seq1.nextval, t2.ida = seq1.nextval where t1.ida < 5;
ERROR HY000: wrong position for sequence: 
update t1 set ida = seq1.nextval, age = (select seq2.nextval from dual) where ida = 15;
ERROR HY000: wrong position for sequence: test.seq2
drop table t1, t2;
drop sequence seq1;
drop sequence seq2;
[#### test bug8528 start ####]
create table t1(c1 varchar(20), c2 varchar(20));
insert into t1 values('11', 'aa'),('22', 'bb');
create sequence seq2 start with 2 increment by 2 minvalue 1 maxvalue 1000000 cycle cache 10 order;
select c1, row_number() over (partition by seq2.nextval order by t1.c2) from t1;
ERROR HY000: wrong position for sequence: 
select c1, row_number() over (order by seq2.nextval) from t1;
ERROR HY000: wrong position for sequence: 
select * from t1 order by seq2.nextval;
ERROR HY000: wrong position for sequence: 
select sum(seq2.nextval) from t1;
ERROR HY000: wrong position for sequence: 
select max(seq2.nextval) from t1;
ERROR HY000: wrong position for sequence: 
select FIRST_VALUE(seq2.nextval) OVER (order by t1.c2) from t1;
ERROR HY000: wrong position for sequence: 
select FIRST_VALUE(max(seq2.nextval)) OVER (order by t1.c2) from t1;
ERROR HY000: wrong position for sequence: 
select c1, seq2.nextval, row_number() over (order by t1.c2) from t1;
c1	nextval	row_number() over (order by t1.c2)
11	2	1
22	4	2
drop table t1;
drop sequence seq2;
[#### test bug8528 end ####]
[#### test bug8742 start ####]
create table t1(c1 varchar(20), c2 varchar(20));
insert into t1 values('11', 'aa'),('22', 'bb'), ('33', 'aa'), ('44', 'bb');
create table t2(c1 varchar(20), c2 varchar(20));
insert into t2 select * from t1;
create sequence seq2 start with 2 increment by 2 minvalue 1 maxvalue 1000000 cycle cache 10 order;
select t1.c1, t2.c2, seq2.nextval, row_number() over (partition by t1.c1 order by t1.c2) from t1, t2 where t1.c1 = t2.c1 and t1.c2 = t2.c2;
c1	c2	nextval	row_number() over (partition by t1.c1 order by t1.c2)
11	aa	2	1
22	bb	4	1
33	aa	6	1
44	bb	8	1
select t1.c1, t2.c2, seq2.nextval, row_number() over (partition by t1.c2 order by t1.c1) from t1, t2 where t1.c1 = t2.c1 and t1.c2 = t2.c2;
c1	c2	nextval	row_number() over (partition by t1.c2 order by t1.c1)
11	aa	10	1
33	aa	14	2
22	bb	12	1
44	bb	16	2
select t1.c1, t2.c2, seq2.nextval, row_number() over (order by t1.c1) from t1, t2 where t1.c1 = t2.c1 and t1.c2 = t2.c2;
c1	c2	nextval	row_number() over (order by t1.c1)
11	aa	18	1
22	bb	20	2
33	aa	22	3
44	bb	24	4
select t1.c1, t2.c2, seq2.nextval, row_number() over (partition by t1.c2) from t1, t2 where t1.c1 = t2.c1 and t1.c2 = t2.c2;
c1	c2	nextval	row_number() over (partition by t1.c2)
11	aa	26	1
33	aa	30	2
22	bb	28	1
44	bb	32	2
select seq2.nextval, FIRST_VALUE(t1.c1) OVER (partition by t1.c1 order by t1.c2) from t1, t2 where t1.c1 = t2.c1 and t1.c2 = t2.c2;
nextval	FIRST_VALUE(t1.c1) OVER (partition by t1.c1 order by t1.c2)
34	11
36	22
38	33
40	44
select seq2.nextval, FIRST_VALUE(t1.c1) OVER (partition by t1.c2 order by t1.c1) from t1, t2 where t1.c1 = t2.c1 and t1.c2 = t2.c2;
nextval	FIRST_VALUE(t1.c1) OVER (partition by t1.c2 order by t1.c1)
42	11
46	11
44	22
48	22
drop table t1;
drop table t2;
drop sequence seq2;
[#### test bug8742 end ####]

[######### test dml in sp #########]
create table t1(c1 int primary key, c2 int);
create sequence seq;

[# test prepared statement(similar in sp)]
prepare sql1 from 'insert into t1 values (seq.nextval,seq.currval)';
execute sql1;
execute sql1;
execute sql1;
select * from t1;
c1	c2
1	1
2	2
3	3
prepare sql2 from 'update t1 set c1=seq.currval, c2 = seq.nextval';
execute sql2;
select * from t1;
c1	c2
4	4
5	5
6	6
execute sql2;
select * from t1;
c1	c2
7	7
8	8
9	9
execute sql2;
select * from t1;
c1	c2
10	10
11	11
12	12
truncate table t1;
deallocate prepare sql1;
deallocate prepare sql2;

[# test in sp(procedure,function,trigger)]
create procedure sp1()
begin
insert into t1 values(seq.nextval, seq.currval);
end;$$
create procedure sp2()
begin
update t1 set c1=seq.currval, c2=seq.nextval;
end;$$
call sp1();
call sp1();
call sp1();
select * from t1;
c1	c2
13	13
14	14
15	15
call sp2();
select * from t1;
c1	c2
16	16
17	17
18	18
call sp2();
select * from t1;
c1	c2
19	19
20	20
21	21
call sp2();
select * from t1;
c1	c2
22	22
23	23
24	24
drop procedure sp1;
drop procedure sp2;

[# bugfix 6679: http://zbox.greatdb.com/zentao/bug-view-6679.html]
select lpad(seq.nextval, 18, 0);
lpad(seq.nextval, 18, 0)
000000000000000025
drop table t1;
drop sequence seq;

[# bugfix 7472:http://zbox.greatdb.com/zentao/bug-view-7472.html]
drop procedure if exists p1;
Warnings:
Note	1305	PROCEDURE test.p1 does not exist
drop table if exists t1;
Warnings:
Note	1051	Unknown table 'test.t1'
create table t1(i int);
create procedure p1()
begin
declare max int;
drop sequence if exists myseq;
create sequence myseq start with 1 increment by 1;
set @max=(select myseq.nextval from dual);
end$$
call p1();
ERROR HY000: wrong position for sequence: 
drop sequence myseq;
drop procedure p1;
drop table t1;

[# bugfix 7453: http://zbox.greatdb.com/zentao/bug-view-7453.html]
delete from mysql.greatdb_sequences_persist;
drop sequence if exists myseq;
Warnings:
Note	8583	sequence 'test.myseq' not exists
create sequence myseq minvalue 1000 start with 1000 maxvalue 10000 increment by 1000;
select myseq.nextval from dual;
nextval
1000
select myseq.currval from dual;
currval
1000
alter sequence myseq maxvalue 6000;
ERROR HY000: alter sequence failed, cause "currval" should between MINVALUE and MAXVALUE!
drop sequence if exists myseq;
create sequence myseq minvalue 1000 start with 1000 maxvalue 10000 increment by 1000;
drop sequence myseq;

[# bugfix 7617:http://zbox.greatdb.com/zentao/bug-view-7617.html]
drop sequence if exists myseq;
Warnings:
Note	8583	sequence 'test.myseq' not exists
create sequence myseq start with 1;
drop view if exists v1;
Warnings:
Note	1051	Unknown table 'test.v1'
create view v1 as select myseq.nextval from dual;
ERROR HY000: View's SELECT refers to a sequence 'myseq'
drop sequence myseq;

[# bugfix 8144:http://zbox.greatdb.com/zentao/bug-view-8144.html]
[sequence in cursor]
create table t1(id int);
insert into t1 values (1);
create sequence myseq;
select @@sql_mode into @sql_mode_saved;
set sql_mode=oracle;
CREATE or replace PROCEDURE p1() as
a int;
cursor c2 is select myseq.nextval from t1;
begin 
open c2;
loop
fetch c2 into a; 
exit when c2%notfound; 
select a; 
end loop;
end;$$
call p1();
a
1
call p1();
a
2
drop sequence myseq;
drop procedure p1;
drop table t1;
set @@sql_mode = @sql_mode_saved;

[# bugfix 7455:http://zbox.greatdb.com/zentao/bug-view-7455.html]
drop sequence if exists seq_cycle;
Warnings:
Note	8583	sequence 'test.seq_cycle' not exists
create sequence seq_cycle increment by 1 start with 10 minvalue 5 cycle;
ERROR HY000: create sequence failed, cause ascending sequences that CYCLE must specify MAXVALUE!

[# bugfix 7448:http://zbox.greatdb.com/zentao/bug-view-7448.html]
CREATE SEQUENCE MYSEQ MINVALUE 1 START WITH 10000 MAXVALUE 15000 INCREMENT BY 6000 CYCLE CACHE 2;
drop sequence MYSEQ;
CREATE SEQUENCE MYSEQ MINVALUE 1 START WITH 10000 MAXVALUE 15000 INCREMENT BY 6000 CYCLE CACHE 10;
ERROR HY000: create sequence failed, cause number to CACHE must be less than one cycle!
create sequence xx;
select xx.nextval;
nextval
1
alter sequence xx  Minvalue 15;
ERROR HY000: alter sequence failed, cause alter MINVALUE can't greater than "currval" 
drop sequence xx;
