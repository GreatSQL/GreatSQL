# This test tests the ST_PointAtDistance function

--echo #
--echo # Different input paths
--echo #

USE test;
CREATE TABLE gis_geometrycollection(fid INTEGER NOT NULL PRIMARY KEY, g GEOMETRY);
SET @ls='LINESTRING(0 0,0 1)';
INSERT INTO gis_geometrycollection VALUES (101,ST_GEOMFROMTEXT(@ls));
--echo # 1 row.
SELECT count(g IS NULL) FROM gis_geometrycollection;

--echo # Test different input paths, must pass
SELECT ST_ASTEXT(ST_POINTATDISTANCE(ST_GEOMFROMTEXT(@ls), 0.5));
SELECT ST_ASTEXT(ST_POINTATDISTANCE(g, 0.5)) FROM gis_geometrycollection WHERE fid=101;
SELECT ST_ASTEXT(ST_POINTATDISTANCE(ST_GEOMFROMTEXT('LINESTRING(0 0,0 1)'), 0.5));

DROP TABLE gis_geometrycollection;

--echo #
--echo # NULL values.
--echo #

--echo # At least one NULL parameter. Must return NULL.
SELECT ST_POINTATDISTANCE(NULL, NULL);
SELECT ST_POINTATDISTANCE(NULL, 2);
SELECT ST_POINTATDISTANCE(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1)', 4326), NULL);

--echo #
--echo # Invalid parameters.
--echo #

--echo # Invalid geometry. Must raise error.
--error ER_GIS_INVALID_DATA
DO ST_POINTATDISTANCE(x'000000000123456789abcdef', 1);

--echo # Non-existing SRID. Must raise error.
# Assume SRID 4294967295 is undefined.
--error ER_SRS_NOT_FOUND
DO ST_POINTATDISTANCE(0xffffffff01020000000500000000000000000000000000000000000000000000000000F03F000000000000F03F000000000000F03F00000000000000400000000000000040000000000000F03F00000000000000400000000000000040,1);

--echo # Latitude values must be within range [-90, 90].
--error ER_GEOMETRY_PARAM_LATITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE61000000102000000020000000000000000000000F2D24D62108056C000000000000000000000000000000000, 1);
--error ER_GEOMETRY_PARAM_LATITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE6100000010200000002000000000000000000000000000000000000000000000000000000F2D24D62108056C0, 1);
--error ER_GEOMETRY_PARAM_LATITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE61000000102000000020000000000000000000000F2D24D621080564000000000000000000000000000000000, 1);
--error ER_GEOMETRY_PARAM_LATITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE6100000010200000002000000000000000000000000000000000000000000000000000000F2D24D6210805640, 1);

--echo # Longitude values must be within range (-180, 180].
--error ER_GEOMETRY_PARAM_LONGITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE610000001020000000200000079E92631088066C0000000000000000000000000000000000000000000000000, 1);
--error ER_GEOMETRY_PARAM_LONGITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE61000000102000000020000000000000000000000000000000000000079E92631088066C00000000000000000, 1);
--error ER_GEOMETRY_PARAM_LONGITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE610000001020000000200000079E9263108806640000000000000000000000000000000000000000000000000, 1);
--error ER_GEOMETRY_PARAM_LONGITUDE_OUT_OF_RANGE
DO ST_POINTATDISTANCE(0xE61000000102000000020000000000000000000000000000000000000079E92631088066400000000000000000, 1);

--echo #
--echo # Wrong arguments
--echo #

--echo # The geometry must be a linestring.
--echo # Cartesian SRID 0
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('POINT(0 0)', 0), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('POLYGON((0 0, 0 1, 1 1, 0 0))', 0), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('MULTIPOINT((0 0), (1 1))', 0), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('MULTILINESTRING((0 0, 1 1))', 0), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('MULTIPOLYGON(((0 0, 0 1, 1 1, 0 0)))', 0), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('GEOMETRYCOLLECTION(POINT(0 0))', 0), 1);
--echo # Geographic
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('POINT(0 0)', 4326), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('POLYGON((0 0, 0 1, 1 1, 0 0))', 4326), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('MULTIPOINT((0 0), (1 1))', 4326), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('MULTILINESTRING((0 0, 1 1))', 4326), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('MULTIPOLYGON(((0 0, 0 1, 1 1, 0 0)))', 4326), 1);
--error ER_UNEXPECTED_GEOMETRY_TYPE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('GEOMETRYCOLLECTION(POINT(0 0))', 4326), 1);

--echo # The distance cannot be longer than length of linestring and must be positive
--error ER_DATA_OUT_OF_RANGE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1)'), 2);
--error ER_DATA_OUT_OF_RANGE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1)', 4326), 111400);
--echo # Error invoked from length function
--error ER_DATA_OUT_OF_RANGE
DO ST_POINTATDISTANCE(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1e308, 1e308 1e308)', 0), 1);

--echo #
--echo # Excercise code on supported types.
--echo #

--echo # Cartesian
SELECT ST_ASTEXT(ST_POINTATDISTANCE(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1)'), 0.5));
SELECT ST_ASTEXT(ST_LINEINTERPOLATEPOINT(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1)'), 0.5));
SELECT ST_ASTEXT(ST_LINEINTERPOLATEPOINTS(ST_GEOMFROMTEXT('LINESTRING(0 0, 0 1)'), 0.2));
