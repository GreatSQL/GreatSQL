let $MYSQLD_DATADIR = `SELECT @@datadir`;
LET $prev_innodb_file_per_table = `SELECT @@innodb_file_per_table`;
SET GLOBAL innodb_file_per_table = ON;
SELECT @@innodb_file_per_table;

SELECT @@innodb_page_zstd_compression_level;


CREATE TABLE t1 (a INT NOT NULL AUTO_INCREMENT PRIMARY KEY, b LONGTEXT, c LONGTEXT) ENGINE=innodb COMPRESSION="zstd" ROW_FORMAT=DYNAMIC;
INSERT INTO t1(`b`,`c`) VALUES (REPEAT('qwrtt',16384), REPEAT('ASDF',16384)), (REPEAT('yuii',8192), REPEAT('JKLH',8192));
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
FLUSH TABLE t1 WITH READ LOCK;
UNLOCK TABLES;

SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';

ALTER TABLE t1 COMPRESSION="None";
OPTIMIZE TABLE t1;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';

CHECK TABLE t1;

ALTER TABLE t1 COMPRESSION="ZLIB";
OPTIMIZE TABLE t1;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';
CHECK TABLE t1;

ALTER TABLE t1 COMPRESSION="ZSTD";
OPTIMIZE TABLE t1;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';
CHECK TABLE t1;



--echo #
--echo # compare the space usage between compressed and non-compressed
--echo #

CREATE TABLE t2 (a INT NOT NULL AUTO_INCREMENT PRIMARY KEY, b LONGTEXT, c LONGTEXT) ENGINE=innodb COMPRESSION="None" ROW_FORMAT=DYNAMIC;
INSERT INTO t2(`b`,`c`) VALUES (REPEAT('qwrtt',16384), REPEAT('ASDF',16384)), (REPEAT('yuii',8192), REPEAT('JKLH',8192));
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
FLUSH TABLE t2 WITH READ LOCK;
UNLOCK TABLES;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t2';
CHECK TABLE t2;


DROP TABLE t1;
DROP TABLE t2;

eval SET GLOBAL INNODB_FILE_PER_TABLE=$prev_innodb_file_per_table;