################################################################################################################
# Bug #32299738: GEOMETRY COLUMNS OF TYPE DATA_BLOB FROM 5.6 MAKES UPGRADE FROM 5.7 TO 8.0 FAIL
################################################################################################################

# This test validates that the tables created with GEOMETRY type columns in 5.6 and 5.7 version are
# successfully upgraded to 8.0 version.
# The database being upgraded was generated by following steps:
# 1. Created the database in 5.6
# 2. Created table t56_geometry_table with geometry datatypes
# 3. Upgraded the database to 5.7
# 4. Created table t57_geometry_table with geometry datatypes and spatial indexes
# 5. Table t56_geometry_table was altered to add a spatial index while running with 5.7 as spatial indexes
#    on InnoDB tables were not supported in 5.6

--source include/have_debug.inc
--source include/not_valgrind.inc
--source include/have_case_sensitive_file_system.inc

--disable_query_log
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* Incorrect definition of table mysql.event");
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* Incorrect definition of table mysql.proc");
call mtr.add_suppression("\\[Warning\\] .* System table 'plugin' is expected to be transactional.");
call mtr.add_suppression("\\[Warning\\] .* System table 'time_zone_leap_second' is expected to be transactional.");
call mtr.add_suppression("\\[Warning\\] .* System table 'time_zone_name' is expected to be transactional.");
call mtr.add_suppression("\\[Warning\\] .* System table 'time_zone' is expected to be transactional.");
call mtr.add_suppression("\\[Warning\\] .* System table 'time_zone_transition_type' is expected to be transactional.");
call mtr.add_suppression("\\[Warning\\] .* System table 'time_zone_transition' is expected to be transactional.");
call mtr.add_suppression("\\[Warning\\] .* db.opt file not found for test database.");
--enable_query_log

--echo #
--echo # This test upgrades a 5.7 database with a table containing GEOMETRY columns. This table
--echo # was originally created in 5.6 and then upgraded to 5.7. An additional table containing
--echo # GEOMETRY columns was created in 5.7
--echo #

--echo # Stop the running server
--source include/shutdown_mysqld.inc

--echo #################################################################################
--echo # Copy and unzip the datadir created with 5.6 version and upgraded to 5.7
--echo #################################################################################

--copy_file $MYSQLTEST_VARDIR/std_data/data_geometry_56.zip $MYSQL_TMP_DIR/data_geometry_56.zip
--file_exists $MYSQL_TMP_DIR/data_geometry_56.zip
--exec unzip -qo $MYSQL_TMP_DIR/data_geometry_56.zip -d $MYSQL_TMP_DIR
let $DATADIR = $MYSQL_TMP_DIR/data_geometry_56;

--echo # Restart the server with the unzipped datadir
--replace_result $DATADIR DATADIR
--let $wait_counter=3000
--let $restart_parameters = restart: --datadir=$DATADIR --innodb_page_size=16k
--source include/start_mysqld.inc

--echo # Check the contents of INFORMATION_SCHEMA
SHOW TABLES;
SELECT NAME, ROW_FORMAT, SPACE_TYPE FROM INFORMATION_SCHEMA.INNODB_TABLES WHERE name LIKE '%test/t_%'
ORDER BY name;
SHOW CREATE TABLE t56_geometry_table;
SHOW CREATE TABLE t57_geometry_table;

--echo # Perform some basic operations on the tables
ALTER TABLE t56_geometry_table ADD SPATIAL INDEX si56_geometry (`c56_geometry`);
SHOW CREATE TABLE t56_geometry_table;
ALTER TABLE t57_geometry_table ADD SPATIAL INDEX si57_geometry (`c57_geometry`);
SHOW CREATE TABLE t57_geometry_table;
ALTER TABLE t56_geometry_table DROP INDEX si56_point;
ALTER TABLE t57_geometry_table DROP INDEX si57_point;
SHOW CREATE TABLE t56_geometry_table;
SHOW CREATE TABLE t57_geometry_table;

--echo # Cleanup
--echo # Shutdown server
--source include/shutdown_mysqld.inc

--echo # Remove copied files
--file_exists $MYSQL_TMP_DIR/data_geometry_56.zip
--force-rmdir $MYSQL_TMP_DIR/data_geometry_56
--remove_file $MYSQL_TMP_DIR/data_geometry_56.zip

--echo # Restart the server
let $restart_parameters=;
--source include/start_mysqld.inc
