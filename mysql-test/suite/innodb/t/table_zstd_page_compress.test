--source include/have_innodb_max_16k.inc
--source include/have_punch_hole.inc



SET DEFAULT_STORAGE_ENGINE=InnoDB;

--echo # ZSTD option NOT affect already exist compress options

CREATE TABLE t1(a INT PRIMARY KEY);
SHOW CREATE TABLE t1;
INSERT INTO t1 values (1),(2),(3),(4),(5);
FLUSH TABLES t1 WITH READ LOCK;
UNLOCK TABLES;
SELECT * FROM t1;



CREATE TABLE t2(a INT PRIMARY KEY) compression="ZLIB";
SHOW CREATE TABLE t2;
INSERT INTO t2 values (1),(2),(3),(4),(5);
FLUSH TABLES t2 WITH READ LOCK;
UNLOCK TABLES;
SELECT * FROM t2;

CREATE TABLE t3(a INT PRIMARY KEY) compression="LZ4";
SHOW CREATE TABLE t3;
INSERT INTO t3 VALUES (1),(2),(3),(4),(5);
FLUSH TABLES t3 WITH READ LOCK;
UNLOCK TABLES;
SELECT * FROM t3;


CREATE TABLE t4(a INT PRIMARY KEY, b VARCHAR(100), c VARCHAR(20) DEFAULT "xyz") compression="ZSTD";
SHOW CREATE TABLE t4;
INSERT INTO t4(a,b) VALUES (1, REPEAT('a', 50)), (2, REPEAT('b', 51)), (3, REPEAT('c',52)), (4, REPEAT('d', 32)), (5,REPEAT('E',80));
FLUSH TABLES t4 WITH READ LOCK;
UNLOCK TABLES;
SELECT * from t4;

SELECT TABLE_NAME, TABLE_SCHEMA, CREATE_OPTIONS, ROW_FORMAT, ENGINE FROM INFORMATION_SCHEMA.TABLES WHERE CREATE_OPTIONS LIKE '%COMPRESSION=%' AND TABLE_SCHEMA="test" ORDER BY TABLE_NAME;


--echo #CREATE TABLE: ZSTD + KEY_BLOCK_SIZE
--error ER_ILLEGAL_HA
CREATE TABLE t5(a INT PRIMARY KEY, b VARCHAR(100)) COMPRESSION="ZSTD" KEY_BLOCK_SIZE=8;
SHOW WARNINGS;

--echo #CREATE TABLE: ZSTD + ROW_FORMAT=COMPRESSED

--error ER_ILLEGAL_HA
CREATE TABLE t6(a INT PRIMARY KEY, c TEXT(200)) COMPRESSION="ZSTD" ROW_FORMAT=COMPRESSED;
SHOW WARNINGS;


--echo # CREATE TABLE: COMPRESSION + TEMPORARY
--error ER_ILLEGAL_HA
CREATE TEMPORARY TABLE t7(a INT PRIMARY KEY) COMPRESSION="ZLIB";
SHOW WARNINGS;

--error ER_ILLEGAL_HA
CREATE TEMPORARY TABLE t8(a INT PRIMARY KEY, b VARCHAR(100)) COMPRESSION="ZSTD";
SHOW WARNINGS;


--echo # CREATE TABLE: COMPRESSION + TABLESPACE=innodb_system
--error ER_ILLEGAL_HA
CREATE TABLE t9(a INT PRIMARY KEY, b CHAR(50)) COMPRESSION="ZLIB" TABLESPACE=innodb_system;
SHOW WARNINGS;

--error ER_ILLEGAL_HA
CREATE TABLE t10(a INT PRIMARY KEY, b CHAR(50)) COMPRESSION="ZSTD" TABLESPACE=innodb_system;
SHOW WARNINGS;

--echo # CREATE TABLE: COMPRESSION + TABLESPACE=innodb_temporary
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t11(c1 INT PRIMARY KEY) COMPRESSION="ZLIB" TABLESPACE=innodb_temporary;
SHOW WARNINGS;

--echo # CREATE TABLE: COMPRESSION + TABLESPACE=innodb_temporary
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t12(c1 INT PRIMARY KEY) COMPRESSION="ZSTD" TABLESPACE=innodb_temporary;
SHOW WARNINGS;


--echo # TEST THE ALTER OPERATION

CREATE TABLE t13 (a INT AUTO_INCREMENT PRIMARY KEY, b varchar(100), c varchar(200), d INT, KEY(`d`)) COMPRESSION="ZSTD";

INSERT INTO t13(`b`,`c`,`d`) values (REPEAT("ab", 10), REPEAT("jet", 20), 1), (REPEAT("df", 10), REPEAT("bro", 20), 2), (REPEAT("ubu", 10), REPEAT("kilo", 20), 3);
INSERT INTO t13(`b`,`c`,`d`) SELECT b, c, d+1 FROM t13;
INSERT INTO t13(`b`,`c`,`d`) SELECT b, c, d+1 FROM t13; 
INSERT INTO t13(`b`,`c`,`d`) SELECT b, c, d+1 FROM t13; 
INSERT INTO t13(`b`,`c`,`d`) SELECT b, c, d+1 FROM t13; 
INSERT INTO t13(`b`,`c`,`d`) SELECT b, c, d+1 FROM t13; 
FLUSH TABLE t13 WITH READ LOCK;
UNLOCK TABLES;
SELECT a, d FROM t13 WHERE a=1;

ALTER TABLE t13 COMPRESSION="ZLIB";
OPTIMIZE TABLE t13;
SELECT a, d FROM t13 WHERE a=1;
SHOW CREATE TABLE t13;

ALTER TABLE t13 COMPRESSION="ZSTD";
OPTIMIZE TABLE t13;
SELECT a, d FROM t13 WHERE a=1;
SHOW CREATE TABLE t13;

ALTER TABLE t13 COMPRESSION="None";
OPTIMIZE TABLE t13;
SELECT a, d FROM t13 WHERE a=2;
SHOW CREATE TABLE t13;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t13';



ALTER TABLE t13 COMPRESSION="ZSTD";
OPTIMIZE TABLE t13;
SELECT a, d FROM t13 WHERE a=2;
SHOW CREATE TABLE t13;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t13';


--echo #
--echo # BUG#22916982 - ASSERT 0 IN FSP_SDI_GET_ROOT_PAGE_NUM(), FLUSH TABLES FOR EXPORT
--echo #

CREATE TABLE t14 (a INT) ENGINE=INNODB ROW_FORMAT=DYNAMIC COMPRESSION='ZSTD';
FLUSH TABLE t14 FOR EXPORT;
--source include/restart_mysqld.inc
FLUSH TABLE t14 FOR EXPORT;
UNLOCK TABLES;


--echo #
--echo # Cleanup
--echo #

DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
DROP TABLE IF EXISTS t3;
DROP TABLE IF EXISTS t4;
DROP TABLE IF EXISTS t13;
DROP TABLE t14;