#
# PS-7338 : Assertion failure: os0file.cc:1767:key_version_read_from_page != ENCRYPTION_KEY_VERSION_NOT_ENCRYPTED
#
CREATE TABLESPACE tab02k_e ADD DATAFILE 'tab02k_e.ibd'  FILE_BLOCK_SIZE 02k ENCRYPTION='Y' ;
CREATE TABLESPACE tab04k ADD DATAFILE 'tab04k.ibd'  FILE_BLOCK_SIZE 04k ENCRYPTION='N' ;
CREATE TABLESPACE tab08k ADD DATAFILE 'tab08k.ibd'  FILE_BLOCK_SIZE 08k ENCRYPTION='N' ;
CREATE TABLESPACE tab16k_e ADD DATAFILE 'tab16k_e.ibd'  FILE_BLOCK_SIZE 16k ENCRYPTION='Y' ;
CREATE UNDO TABLESPACE undo_001 ADD DATAFILE 'undo_001.ibu' ;
CREATE UNDO TABLESPACE undo_002 ADD DATAFILE 'undo_002.ibu' ;
CREATE UNDO TABLESPACE undo_003 ADD DATAFILE 'undo_003.ibu' ;
CREATE TEMPORARY TABLE tt_0_t (ipkey INT AUTO_INCREMENT, mt1 MEDIUMTEXT COLUMN_FORMAT COMPRESSED, i2 INT, c3 CHAR(18), c4 CHAR(30),  PRIMARY KEY(ipkey), INDEX tt_0_ti0(ipkey DESC, c3, c4) , INDEX tt_0_ti1(ipkey)  ) ENGINE=INNODB ;
CREATE TABLE tt_1 (i0 INT AUTO_INCREMENT, i1 INT(33), f2 FLOAT, i3 INT, f4 FLOAT, mt5 MEDIUMTEXT, d6 DOUBLE, INDEX tt_1i0(i1 ASC, i0 ASC, f2) , INDEX tt_1i1(i0, f4 DESC, f2, i3 ASC, mt5(14))  ) ENCRYPTION='N' TABLESPACE=tab08k KEY_BLOCK_SIZE=8 ENGINE=INNODB ;
Warnings:
Warning	1681	Integer display width is deprecated and will be removed in a future release.
CREATE TABLE tt_2 (i0 INT AUTO_INCREMENT, i1 INT, INDEX tt_2i0(i0, i1)  ) ENCRYPTION='N' TABLESPACE=innodb_system ENGINE=INNODB ;
CREATE TABLE tt_3 (lt0 LONGTEXT COLUMN_FORMAT COMPRESSED, i1 INT, d2 DOUBLE, i3 INT AUTO_INCREMENT, g4  VARCHAR(12) AS  (CONCAT(SUBSTRING(i1,1,6),SUBSTRING(d2,1,2),SUBSTRING(i1,1,4))) STORED, INDEX tt_3i0(i3 DESC, d2) , INDEX tt_3i1(i1 ASC) , INDEX tt_3i2(i3 ASC) , INDEX tt_3i3(i3 DESC, i1 DESC, g4)  ) ENCRYPTION='N' TABLESPACE=tab08k KEY_BLOCK_SIZE=8 ENGINE=INNODB ;
CREATE TABLE tt_4 (f0 FLOAT, i1 INT(21) AUTO_INCREMENT, v2 VARCHAR(29), INDEX tt_4i0(i1 DESC)  ) ENCRYPTION='N' KEY_BLOCK_SIZE=2 ROW_FORMAT=COMPRESSED ENGINE=INNODB ;
Warnings:
Warning	1681	Integer display width is deprecated and will be removed in a future release.
CREATE TABLE tt_5 (b0 BLOB COLUMN_FORMAT COMPRESSED, c1 CHAR(12), i2 INT AUTO_INCREMENT, d3 DOUBLE, g4  BLOB AS  (CONCAT(SUBSTRING(b0,1,1),SUBSTRING(d3,1,4),SUBSTRING(d3,1,4))), INDEX tt_5i0(c1) , INDEX tt_5i1(i2 ASC, g4(25) ASC, c1 ASC) , INDEX tt_5i2(c1 ASC, d3, g4(1) DESC, i2)  ) ENCRYPTION='N' KEY_BLOCK_SIZE=2 ENGINE=INNODB ;
CREATE TABLE tt_6 (t0 BOOL, c1 CHAR(18), f2 FLOAT, i3 INT AUTO_INCREMENT, g4  CHAR(2) AS  (CONCAT(SUBSTRING(f2,1,2))) STORED, INDEX tt_6i0(t0 DESC) , INDEX tt_6i1(t0 DESC, i3, c1, f2 DESC, g4) , INDEX tt_6i2(g4, i3 DESC) , INDEX tt_6i3(i3, c1, g4 DESC, f2 ASC) , INDEX tt_6i4(i3 DESC, c1)  ) ENCRYPTION='N' TABLESPACE=tab08k KEY_BLOCK_SIZE=8 ENGINE=INNODB ;
CREATE TABLE tt_7 (ipkey INT AUTO_INCREMENT,  PRIMARY KEY(ipkey), INDEX tt_7i0(ipkey)  ) ENCRYPTION='Y' TABLESPACE=tab16k_e ENGINE=INNODB ;
CREATE TABLE tt_8 (ipkey INT AUTO_INCREMENT, c1 CHAR(12), t2 TEXT COLUMN_FORMAT COMPRESSED, v3 VARCHAR(28), g4  VARCHAR(6) AS  (CONCAT(SUBSTRING(t2,1,6))),  PRIMARY KEY(ipkey), INDEX tt_8i0(ipkey)  ) ENCRYPTION='N' TABLESPACE=tab04k KEY_BLOCK_SIZE=4 ENGINE=INNODB ;
CREATE TABLE tt_9 (mt0 MEDIUMTEXT COLUMN_FORMAT COMPRESSED ) ENCRYPTION='Y' TABLESPACE=tab02k_e KEY_BLOCK_SIZE=2 ENGINE=INNODB ;
CREATE TABLE tt_10 (ipkey INT(30) AUTO_INCREMENT, t1 BOOL, f2 FLOAT,  PRIMARY KEY(ipkey), INDEX tt_10i0(ipkey) , INDEX tt_10i1(f2 DESC) , INDEX tt_10i2(ipkey, f2)  ) ENCRYPTION='Y' TABLESPACE=tab16k_e ENGINE=INNODB ;
Warnings:
Warning	1681	Integer display width is deprecated and will be removed in a future release.
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLE tt_1 RENAME COLUMN f4 To f4_rename, LOCK=DEFAULT, ALGORITHM=INPLACE ;
ALTER TABLESPACE tab08k ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab08k ENCRYPTION 'N' ;
ALTER TABLESPACE tab16k_e ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab08k ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab16k_e ENCRYPTION 'Y' ;
ALTER TABLESPACE tab04k ENCRYPTION 'N' ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER TABLESPACE tab16k_e ENCRYPTION 'N' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'N' ;
ALTER TABLESPACE tab08k ENCRYPTION 'Y' ;
START TRANSACTION ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'N' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab08k ENCRYPTION 'N' ;
ALTER TABLESPACE tab08k ENCRYPTION 'N' ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'N' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab04k ENCRYPTION 'N' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab08k ENCRYPTION 'N' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'N' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab08k ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab08k ENCRYPTION 'Y' ;
SAVEPOINT SAVE1 ;
ALTER TABLESPACE tab04k ENCRYPTION 'N' ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'Y' ;
ALTER TABLESPACE tab08k ENCRYPTION 'Y' ;
ALTER TABLESPACE tab16k_e ENCRYPTION 'N' ;
ALTER TABLESPACE tab16k_e ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
SAVEPOINT SAVE1 ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER TABLE tt_0_t RENAME COLUMN c4 To c4_rename, LOCK=NONE, ALGORITHM=DEFAULT ;
ALTER TABLESPACE tab16k_e ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLESPACE tab04k ENCRYPTION 'Y' ;
ALTER TABLESPACE tab02k_e ENCRYPTION 'Y' ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER TABLE tt_2 RENAME INDEX tt_2i0 To tt_2i0_rename, LOCK=SHARED, ALGORITHM=INPLACE ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
ALTER INSTANCE ROTATE INNODB MASTER KEY ;
# record table checksums so that we can verify post crash recovery
create table checksum(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, a BIGINT);
# Kill and restart
# verify checksums
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
include/assert.inc [Table checksum must match after crash recovery]
# test cleanup
ALTER UNDO TABLESPACE undo_001 SET INACTIVE ENGINE InnoDB;
ALTER UNDO TABLESPACE undo_002 SET INACTIVE ENGINE InnoDB;
ALTER UNDO TABLESPACE undo_003 SET INACTIVE ENGINE InnoDB;
DROP UNDO TABLESPACE undo_001 ENGINE InnoDB;
DROP UNDO TABLESPACE undo_002 ENGINE InnoDB;
DROP UNDO TABLESPACE undo_003 ENGINE InnoDB;
DROP TABLE tt_1, tt_2, tt_3, tt_4, tt_5, tt_6, tt_7, tt_8, tt_9, tt_10;
DROP TABLE checksum;
DROP TABLESPACE tab02k_e;
DROP TABLESPACE tab04k;
DROP TABLESPACE tab08k;
DROP TABLESPACE tab16k_e;
