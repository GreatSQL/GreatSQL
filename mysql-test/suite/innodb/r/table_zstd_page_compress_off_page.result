SET GLOBAL innodb_file_per_table = ON;
SELECT @@innodb_file_per_table;
@@innodb_file_per_table
1
SELECT @@innodb_page_zstd_compression_level;
@@innodb_page_zstd_compression_level
6
CREATE TABLE t1 (a INT NOT NULL AUTO_INCREMENT PRIMARY KEY, b LONGTEXT, c LONGTEXT) ENGINE=innodb COMPRESSION="zstd" ROW_FORMAT=DYNAMIC;
INSERT INTO t1(`b`,`c`) VALUES (REPEAT('qwrtt',16384), REPEAT('ASDF',16384)), (REPEAT('yuii',8192), REPEAT('JKLH',8192));
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
INSERT INTO t1(`b`,`c`) SELECT `b`, `c` FROM t1;
FLUSH TABLE t1 WITH READ LOCK;
UNLOCK TABLES;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';
NAME	FS_BLOCK_SIZE	FILE_SIZE	ACTUAL_SIZE_MB
test/t1	4096	11534336	5
ALTER TABLE t1 COMPRESSION="None";
OPTIMIZE TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t1	optimize	status	OK
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';
NAME	FS_BLOCK_SIZE	FILE_SIZE	ACTUAL_SIZE_MB
test/t1	4096	11534336	11
CHECK TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
ALTER TABLE t1 COMPRESSION="ZLIB";
OPTIMIZE TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t1	optimize	status	OK
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';
NAME	FS_BLOCK_SIZE	FILE_SIZE	ACTUAL_SIZE_MB
test/t1	4096	11534336	5
CHECK TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
ALTER TABLE t1 COMPRESSION="ZSTD";
OPTIMIZE TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t1	optimize	status	OK
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t1';
NAME	FS_BLOCK_SIZE	FILE_SIZE	ACTUAL_SIZE_MB
test/t1	4096	11534336	5
CHECK TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
#
# compare the space usage between compressed and non-compressed
#
CREATE TABLE t2 (a INT NOT NULL AUTO_INCREMENT PRIMARY KEY, b LONGTEXT, c LONGTEXT) ENGINE=innodb COMPRESSION="None" ROW_FORMAT=DYNAMIC;
INSERT INTO t2(`b`,`c`) VALUES (REPEAT('qwrtt',16384), REPEAT('ASDF',16384)), (REPEAT('yuii',8192), REPEAT('JKLH',8192));
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
INSERT INTO t2(`b`,`c`) SELECT `b`, `c` FROM t2;
FLUSH TABLE t2 WITH READ LOCK;
UNLOCK TABLES;
SELECT NAME, FS_BLOCK_SIZE, FILE_SIZE, ROUND(ALLOCATED_SIZE/1024/1024) AS ACTUAL_SIZE_MB FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='test/t2';
NAME	FS_BLOCK_SIZE	FILE_SIZE	ACTUAL_SIZE_MB
test/t2	4096	11534336	11
CHECK TABLE t2;
Table	Op	Msg_type	Msg_text
test.t2	check	status	OK
DROP TABLE t1;
DROP TABLE t2;
SET GLOBAL INNODB_FILE_PER_TABLE=1;
